<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Insert</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="/lib/jquery-3.2.1.min.js"></script>
</head>
<body>
    <form onsubmit="return false;">
        <div>Data inicial: <input type="date" id="date"></div>
        <div>Quantidade de Dias: <input type="number" id="qnt" min="1" max="500"></div>
        <div><input type="submit" value="Submit" id="submit"></div>
    </form>

    <script>

        $("#submit").on("click", function () {
            var date = new Date($("#date").val());
            date.setHours(date.getHours() + (date.getTimezoneOffset() / 60));
            var qnt = $("#qnt").val();

            var i = 0;
            
            while (i < qnt) {
                setTimeout(function() {
                    submitDay(date.getFullYear() + dateFix(date.getMonth() + 1) + dateFix(date.getDate()));
                    date.setDate(date.getDate() + 1);
                }, 6 * qnt);
                i++;
            }
        });

        function dateFix(num) {
            return num < 10 ? "0" + num : num.toString();
        }

        function submitDay(YYYYMMDD) {
            $.ajax({
                url: "//api.wunderground.com/api/863a1b76beeb23bd/history_" + YYYYMMDD + "/q/zmw:00000.100.83779.json",
                success: function (data) {
                    if (typeof data.history.dailysummary[0] !== "undefined") {
                        $.ajax({
                            method: "POST",
                            url: "insert-daily.php",
                            data: summaryData(data),
                            success: function (response) {
                                console.log("Ok summary!\n\n" + response)
                            },
                            error: function () {
                                console.log("Error summary!\n\n" + response)
                            }
                        });
                    }

                    $.ajax({
                        method: "POST",
                        url: "insert-hours.php",
                        data: hourlyData(data),
                        success: function (response) {
                            console.log("Ok hours!\n\n" + response)
                        },
                        error: function () {
                            console.log("Error hours!\n\n" + response)
                        }
                    });
                }
            });
        }
        
        function summaryData(data) {
            var json = {};

            var resumo = data.history.dailysummary[0];

            var date = resumo.date;
            var dateStr = date.year + "-" + date.mon + "-" + date.mday;

            json["0"] = {};

            json["0"]["date"] = dateStr;

            //     console.log("------------------------------");
            //     console.log(dateStr);
            //     console.log("------------------------------");
            for (var label in resumo) {
                var dado = resumo[label];
                if (typeof dado != "object") {
                    //             console.log(label + " | " + dado);
                    json["0"][label] = dado;
                }
            }

            return json;
        }

        function hourlyData(data) {
            var json = {};

            var horas = data.history.observations;

            for (var i in horas) {
                var dados = horas[i];
                var date = dados.date;
                var dateStr = date.year + "-" + date.mon + "-" + date.mday;
                var dateTimeStr = date.year + "-" + date.mon + "-" + date.mday + " " + date.hour + ":" + date.min;

                json['"' + i + '"'] = {};

                json['"' + i + '"']["date"] = dateStr;
                json['"' + i + '"']["datetime"] = dateTimeStr;

                //         console.log("------------------------------");
                //         console.log(dateStr);
                //         console.log("------------------------------");
                for (var label in dados) {
                    var dado = dados[label];
                    if (typeof dado != "object") {
                        //                 console.log(label + " | " + dado);
                        json['"' + i + '"'][label] = dado;
                    }
                }
            }

            return json;
        }

    </script>
</body>
</html>