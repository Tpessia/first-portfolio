<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Insert</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="/lib/jquery-3.2.1.min.js"></script>

    <style>
        form>div {
            padding: 10px 0;
        }
        
        #message {
            font-weight: bold;
        }

        #message div {
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <form id="form" onsubmit="return false;">
        <div id="dateDiv">Data inicial: <input type="date" id="date" required></div>
        <div id="qntDiv">Quantidade de Dias: <input type="number" id="qnt" min="1" max="500" required></div>
        <div id="submitDiv"><input type="submit" value="Submit" id="submit"></div>
        <div id="message"></div>
    </form>

    <script>

        $("#form").on("submit", function () {
            $("#message").html('');
            $("#submit").css('background-color','#ff000054');
            $("#submit").css('pointer-events','none');
            $("#message").append("<div>INÍCIO DO PROCESSO</div>");

            var date = new Date($("#date").val());
            date.setHours(date.getHours() + (date.getTimezoneOffset() / 60));
            var qnt = $("#qnt").val();

            var i = 0;
            
            while (i < qnt) {
                setTimeout(function() {
                    submitDay(date.getFullYear() + dateFix(date.getMonth() + 1) + dateFix(date.getDate()), (i == qnt - 1 ? true : false));
                    date.setDate(date.getDate() + 1);
                }, 6000 * i);
                i++;
            }
        });

        function dateFix(num) {
            return num < 10 ? "0" + num : num.toString();
        }

        function submitDay(YYYYMMDD, isLast) {
            $.ajax({
                url: "//api.wunderground.com/api/863a1b76beeb23bd/history_" + YYYYMMDD + "/q/zmw:00000.100.83779.json",
                async: false,
                success: function (data) {
                    $("#message").append("<div>Processando - " + YYYYMMDD + "</div>");

                    if (typeof data.history.dailysummary[0] !== "undefined") {
                        $.ajax({
                            method: "POST",
                            url: "insert-daily.php",
                            async: false,
                            data: summaryData(data),
                            success: function (response) {
                                $("#message").append("<div>Sucesso Resumo - " + YYYYMMDD + "</div>");
                                console.log("Ok summary!\n\n" + response)
                            },
                            error: function () {
                                $("#message").append("<div>Erro Resumo - " + YYYYMMDD + "</div>");
                                console.log("Error summary!\n\n" + response)
                            }
                        });
                    }

                    $.ajax({
                        method: "POST",
                        url: "insert-hours.php",
                        async: false,
                        data: hourlyData(data),
                        success: function (response) {
                            $("#message").append("<div>Sucesso Horário - " + YYYYMMDD + "</div>");
                            console.log("Ok hours!\n\n" + response)
                        },
                        error: function () {
                            $("#message").append("<div>Erro Horário - " + YYYYMMDD + "</div>");
                            console.log("Error hours!\n\n" + response)
                        }
                    });

                    if (isLast) {
                        $("#submit").css('background-color','#00800054');
                        $("#message").append("<div>PROCESSO FINALIZADO</div>");
                    }
                },
                error: function() {
                    $("#message").append("<div>ERRO DE CONEXÃO</div>");
                }
            });
        }
        
        function summaryData(data) {
            var json = {};

            var resumo = data.history.dailysummary[0];

            var date = resumo.date;
            var dateStr = date.year + "-" + date.mon + "-" + date.mday;

            json["0"] = {};

            json["0"]["date"] = dateStr;

            //     console.log("------------------------------");
            //     console.log(dateStr);
            //     console.log("------------------------------");
            for (var label in resumo) {
                var dado = resumo[label];
                if (typeof dado != "object") {
                    //             console.log(label + " | " + dado);
                    json["0"][label] = dado;
                }
            }

            return json;
        }

        function hourlyData(data) {
            var json = {};

            var horas = data.history.observations;

            for (var i in horas) {
                var dados = horas[i];
                var date = dados.date;
                var dateStr = date.year + "-" + date.mon + "-" + date.mday;
                var dateTimeStr = date.year + "-" + date.mon + "-" + date.mday + " " + date.hour + ":" + date.min;

                json['"' + i + '"'] = {};

                json['"' + i + '"']["date"] = dateStr;
                json['"' + i + '"']["datetime"] = dateTimeStr;

                //         console.log("------------------------------");
                //         console.log(dateStr);
                //         console.log("------------------------------");
                for (var label in dados) {
                    var dado = dados[label];
                    if (typeof dado != "object") {
                        //                 console.log(label + " | " + dado);
                        json['"' + i + '"'][label] = dado;
                    }
                }
            }

            return json;
        }

    </script>
</body>
</html>